<%- include('navigationbar') %>
    <!-- Header Section End -->
     <style>
        .card {
    background-color: #fff;
    border-radius: 10px;
    border: none;
    position: relative;
    margin-bottom: 30px;
    box-shadow: 0 0.46875rem 2.1875rem rgba(90,97,105,0.1), 0 0.9375rem 1.40625rem rgba(90,97,105,0.1), 0 0.25rem 0.53125rem rgba(90,97,105,0.12), 0 0.125rem 0.1875rem rgba(90,97,105,0.1);
}
.l-bg-cherry {
    background: linear-gradient(to right, #493240, #f09) !important;
    color: #fff;
}

.l-bg-blue-dark {
    background: linear-gradient(to right, #373b44, #4286f4) !important;
    color: #fff;
}

.l-bg-green-dark {
    background: linear-gradient(to right, #0a504a, #38ef7d) !important;
    color: #fff;
}

.l-bg-orange-dark {
    background: linear-gradient(to right, #a86008, #ffba56) !important;
    color: #fff;
}

.card .card-statistic-3 .card-icon-large .fas, .card .card-statistic-3 .card-icon-large .far, .card .card-statistic-3 .card-icon-large .fab, .card .card-statistic-3 .card-icon-large .fal {
    font-size: 110px;
}

.card .card-statistic-3 .card-icon {
    text-align: center;
    line-height: 50px;
    margin-left: 15px;
    color: #000;
    position: absolute;
    right: -5px;
    top: 20px;
    opacity: 0.1;
}

.l-bg-cyan {
    background: linear-gradient(135deg, #289cf5, #84c0ec) !important;
    color: #fff;
}

.l-bg-green {
    background: linear-gradient(135deg, #23bdb8 0%, #43e794 100%) !important;
    color: #fff;
}

.l-bg-orange {
    background: linear-gradient(to right, #f9900e, #ffba56) !important;
    color: #fff;
}

.l-bg-cyan {
    background: linear-gradient(135deg, #289cf5, #84c0ec) !important;
    color: #fff;
}
/* Style for the coupon container */
.coupon-container {
    display: flex;
    flex-wrap: wrap; /* Allows items to wrap to the next line if they don't fit */
    gap: 10px; /* Adds space between items */
}

/* Style for each coupon item */
.coupon-item {
    display: flex;
    align-items: center; /* Center align items vertically */
    padding: 5px 10px;
    background-color: #f1f1f1; /* Background color for each coupon item */
    border: 1px solid #ddd; /* Border around each coupon item */
    border-radius: 5px; /* Rounded corners */
}

/* Style for the remove button */
.coupon-item .remove-coupon {
    background: none;
    border: none;
    color: #d9534f; /* Red color for the remove button */
    cursor: pointer;
    font-size: 16px; /* Font size for the remove button */
    margin-left: 10px; /* Space between coupon text and remove button */
}

.available-coupons {
    display: flex;
    flex-wrap: wrap; /* Allows cards to wrap to the next line */
    gap: 10px; /* Space between coupon cards */
    padding: 10px; /* Padding inside the container */
}

.coupon-card {
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    cursor: pointer; /* Indicates that the card is clickable */
    flex: 1 1 150px; /* Grow and shrink, with a minimum width */
    transition: background-color 0.3s ease;
}

.coupon-card:hover {
    background-color: #e9ecef; /* Change background on hover */
}

.coupon-code {
    font-size: 16px;
    font-weight: bold;
}
     </style>

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">
                        <h4>Check Out</h4>
                        <div class="breadcrumb__links">
                            <a href="./index.html">Home</a>
                            <a href="./shop.html">Shop</a>
                            <span>Check Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ...
            </div>
        </div>
    </div>
</div>
    <!-- Checkout Section Begin -->
    <section class="checkout spad">
        <div class="container">
            <div id="paymentMessage" style="color: red; display: none;"></div>
            <div class="checkout__form">
             <h6 class="coupon__code" id="show-coupon-form">
    <span class="icon_tag_alt"></span> Have a coupon? <a href="#">Click here</a> to enter your code
</h6>

<div class="cart__discount" id="coupon-form-container" style="display: none;">
<!-- Display all available coupons as cards -->
<div class="available-coupons d-flex">
    <% allCoupons.forEach(function(coupon) { %>
        <div class="coupon-card" data-code="<%= coupon.coupon_code %>">
            <span class="coupon-code">
                <%= coupon.coupon_code %>
            </span>
        </div>
        <% }); %>
</div>

    <form id="coupon-form">
        <input type="text" id="coupon-code" placeholder="Coupon code">
        <button type="submit">Apply</button>
    </form>
<div id="applied-coupons" class="coupon-container">
    <% coupons.forEach(function(coupon) { %>
        <div class="coupon-item">
            <span>
                <%= coupon %>
            </span>
            <button class="remove-coupon" data-code="<%= coupon %>">x</button>
        </div>
        <% }); %>
</div>


    <!-- <button id="close-coupon-form" style="background: none; border: none; cursor: pointer; font-size: 24px; color: #333;">&times;</button> -->
    <div id="coupon-message"></div>
</div>




                <form id="checkoutForm" action="/checkout" method="post">
                    <div class="row">
                        <div class="col-lg-8 col-md-6">


                            <h6 class="checkout__title" data-toggle="collapse" data-target="#billingDetails"
                                aria-expanded="true" aria-controls="billingDetails">Billing Details</h6>
                            <div id="billingDetails" class="collapse show">
                                <div class="addresses-content-wrapper">
                                    <div class="addresses-content">

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="checkout__input">
                                            <p>First name<span>*</span></p>
                                            <input type="text" id="billingFirstName" name="billingFirstName"
                                                value="<%= !session && billingAddress && billingAddress.Address_id ? billingAddress.Address_id.FirstName : '' %>">
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="checkout__input">
                                            <p>Last Name<span>*</span></p>
                                            <input type="text" id="billingLastName" name="billingLastName"
                                                value="<%= !session && billingAddress && billingAddress.Address_id ? billingAddress.Address_id.LastName : '' %>">
                                        </div>
                                    </div>
                                </div>
                                <div class="checkout__input">
                                    <p>Country<span>*</span></p>
                                    <input type="text" id="billingCountry" name="billingCountry"
                                        value="<%= !session && billingAddress && billingAddress.Address_id ? billingAddress.Address_id.Country : '' %>">
                                </div>
                                <div class="checkout__input">
                                    <p>Address<span>*</span></p>
                                    <input type="text" id="billingHouseNumber" name="billingHouseNumber"
                                        value="<%= !session && billingAddress && billingAddress.Address_id ? billingAddress.Address_id.House_number : '' %>"
                                        class="checkout__input__add">
                                    <input type="text" id="billingAddressLine1" name="billingAddressLine1"
                                        value="<%= !session && billingAddress && billingAddress.Address_id ? billingAddress.Address_id.Address_line_1 + ', ' + billingAddress.Address_id.Address_line_2 : '' %>">
                                </div>
                                <div class="checkout__input">
                                    <p>Country/State<span>*</span></p>
                                    <input type="text" id="billingState" name="billingState"
                                        value="<%= !session && billingAddress && billingAddress.Address_id ? billingAddress.Address_id.State : '' %>">
                                </div>
                                <div class="checkout__input">
                                    <p>Postcode / ZIP<span>*</span></p>
                                    <input type="text" id="billingPostalCode" name="billingPostalCode"
                                        value="<%= !session && billingAddress && billingAddress.Address_id ? billingAddress.Address_id.Postal_code : '' %>">
                                </div>

                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="checkout__input">
                                            <p>Phone<span>*</span></p>
                                            <input type="text" id="phone" name="phone"
                                                value="<%= session ? "":user.phone %>">
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="checkout__input">
                                            <p>Email<span>*</span></p>
                                            <input type="text" id="email" name="email"
                                                value="<%= session ? "":user.email %>">
                                        </div>
                                    </div>
                                </div>
                            </div>



                           
                            <div class="checkout__input__checkbox">
                                <h6 class="checkout__title" data-toggle="collapse" data-target="#shippingDetails" aria-expanded="true"
                                    aria-controls="shippingDetails">Shipping Details</h6>
                                <label for="add">
                                    Ship to Same Address
                                    <input type="checkbox" id="add" name="shipToDifferentAddress"
                                        onchange="toggleShippingAddressFields()">
                                    <span class="checkmark"></span>
                                </label>
                            <div id="shippingDetails" class="collapse hide">
                                <div id="shippingFields">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="checkout__input">
                                                <p>First name<span>*</span></p>
                                                <input type="text" id="shippingFirstName" name="shippingFirstName"
                                                    value="<%= session ? '' : shippingAddress && shippingAddress.Address_id ? shippingAddress.Address_id.FirstName : '' %>">
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="checkout__input">
                                                <p>Last Name<span>*</span></p>
                                                <input type="text" id="shippingLastName" name="shippingLastName"
                                                    value="<%= session ? '' : shippingAddress && shippingAddress.Address_id ? shippingAddress.Address_id.LastName : '' %>">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="checkout__input">
                                        <p>Country<span>*</span></p>
                                        <input type="text" id="shippingCountry" name="shippingCountry"
                                            value="<%= session ? '' : shippingAddress && shippingAddress.Address_id ? shippingAddress.Address_id.Country : '' %>">
                                    </div>
                                    <div class="checkout__input">
                                        <p>Address<span>*</span></p>
                                        <input type="text" id="shippingHouseNumber" name="shippingHouseNumber"
                                            value="<%= session ? '' : shippingAddress && shippingAddress.Address_id ? shippingAddress.Address_id.House_number : '' %>"
                                            class="checkout__input__add">
                                        <input type="text" id="shippingAddressLine1" name="shippingAddressLine1"
                                            value="<%= session ? '' : shippingAddress && shippingAddress.Address_id ? `${shippingAddress.Address_id.Address_line_1}, ${shippingAddress.Address_id.Address_line_2}` : '' %>">
                                    </div>
                                    <div class="checkout__input">
                                        <p>Country/State<span>*</span></p>
                                        <input type="text" id="shippingState" name="shippingState"
                                            value="<%= session ? '' : shippingAddress && shippingAddress.Address_id ? shippingAddress.Address_id.State : '' %>">
                                    </div>
                                    <div class="checkout__input">
                                        <p>Postcode / ZIP<span>*</span></p>
                                        <input type="text" id="shippingPostalCode" name="shippingPostalCode"
                                            value="<%= session ? '' : shippingAddress && shippingAddress.Address_id ? shippingAddress.Address_id.Postal_code : '' %>">
                                    </div>
                                </div>
                            </div>
                            </div>
                            <div class="checkout__input__checkbox">
                                <!-- <label for="diff-acc">
                                    Note about your order, e.g, special note for delivery
                                    <input type="checkbox" id="diff-acc">
                                    <span class="checkmark"></span>
                                </label> -->
                            </div>
                            <div class="checkout__input">
                                <p>Order notes<span>*</span></p>
                                <input type="text"
                                    placeholder="Notes about your order, e.g. special notes for delivery.">
                            </div>
                        </div>


                        <div class="col-lg-4 col-md-6">
                            <div class="checkout__order">
                                <h4 class="order__title">Your order</h4>
                                <div class="checkout__order__products">Product <span>Total</span></div>
                                <ul class="checkout__total__products">
                                    <% cartProduct.forEach((element, index)=> { %>
                                        <% if (!session) { %>
                                            <% if (element.Product_variation.Is_active) { %>
                                                <li>0<%= index + 1 %>. <%= element.SingleProduct.product_name %> <span>$
                                                                <%= (element.Product.Original_price * element.Qty).toFixed(2) %>
                                                            </span></li>
                                                <% } %>

                                                    <% } else { %>
                                                        <li>0<%= index + 1 %>. <%=
                                                                    element.product.Product_variation_id.Product_item_id.Product_id.product_name
                                                                    %> <span>$ <%=
                                                                            (element.product.Product_variation_id.Product_item_id.Original_price
                                                                            * element.Qty).toFixed(2) %></span></li>
                                                        <% } %>
                                                            <% }) %>

                                </ul>
                                <ul class="checkout__total__all">
                                    <li>Subtotal <span id="total-cart">$<%= (totalCartAmount).toFixed(2) %></span>
                                        <input type="hidden" name="subtotal" value="<%= (totalCartAmount).toFixed(2) %>">
                                    </li>
                                    <li hidden>Subtotal <span >$<%= couponDiscountPercentage%></span>
                                        <input type="hidden" name="couponDiscountPercentage"
                                            value="<%= couponDiscountPercentage %>">
                                    </li>
                                    <li hidden>Coupon Code <span>$<%= bestCouponCode%></span>
                                        <input type="hidden" name="coupon_code" value="<%= bestCouponCode %>">
                                    </li>

                                    <li>Coupon Discount <span id="coupon-discount">$ <%= (((totalCartAmount-totalOfferDiscount)*couponDiscountPercentage/100).toFixed(2)) %> </span>
                                        <input type="hidden" name="couponDiscount" value="<%= ((totalCartAmount-totalOfferDiscount)*couponDiscountPercentage/100).toFixed(2) %>">
                                    </li>
                                    <li>Offer Discount <span id="store-discount">$ <%= (totalOfferDiscount).toFixed(2) %></span>
                                        <input type="hidden" name="offerDiscount" value="<%= totalOfferDiscount %>">
                                    </li>
                                    <li>Shipping <span>$ 0.00</span>
                                        <input type="hidden" name="shipping" value="0.00">
                                    </li>
                                    <li>Total <span id="total-amount">$<%=((totalCartAmount-totalOfferDiscount)-((totalCartAmount-totalOfferDiscount)*couponDiscountPercentage/100)).toFixed(2) %></span>
                                        <input type="hidden" name="total" value="<%= ((totalCartAmount-totalOfferDiscount)-((totalCartAmount-totalOfferDiscount)*couponDiscountPercentage/100)).toFixed(2) %>">
                                    </li>
                                </ul>

                                <% let codAvailable=true; %>
                                    <% let walletAvailable=true; %>
                                        <% Payment_types.forEach(element=> { %>
                                            <% const isCashOnDelivery=element.Value==='Cash On Delivery' ; %>
                                                <% const finalAmount=((totalCartAmount - totalOfferDiscount) - ((totalCartAmount - totalOfferDiscount) *
                                                    couponDiscountPercentage / 100)).toFixed(2); %>
                                
                                                    <% if (newTotalAmount> 1000 && isCashOnDelivery) { %>
                                                        <% codAvailable=false; %>
                                                            <% } else { %>
                                                                <div class="checkout__input__radio">
                                                                    <label for="payment_<%= element.Value %>">
                                                                        <%= element.Value %>
                                                                            <input type="radio" id="payment_<%= element.Value %>" name="payment_method"
                                                                                value="<%= element.Value %>" data-final-amount="<%= finalAmount %>"
                                                                                data-wallet-amount="<%= userWallet.Wallet_amount %>">
                                                                            <span class="checkmark"></span>
                                                                    </label>
                                                                </div>
                                                                <% } %>
                                                                    <% }); %>
                                
                                                                        <% if (!codAvailable) { %>
                                                                            <p style="color: red;">Cash On Delivery is not available for orders above
                                                                                1000.</p>
                                                                            <% } %>
                                
                                                                                <p id="paymentMessage" style="color: red; display: none;"></p>


<div class="row ">
    <div class="col-md-12">
        <div class="card l-bg-cherry">
            <div class="card-statistic-3 p-4">
                <div class="card-icon card-icon-large"><i class="fas fa-shopping-cart"></i></div>
                <div class="mb-4">
                    <h5 class="card-title mb-0">Wallet Balance</h5>
                </div>
                <div class="row align-items-center mb-2 d-flex">
                    <div class="col-8">
                        <h2 class="d-flex align-items-center mb-0">
                            <%= (userWallet.Wallet_amount).toFixed(2) %>
                        </h2>
                    </div>
                    
                </div>
                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                    <div class="progress-bar l-bg-cyan" role="progressbar" data-width="25%" aria-valuenow="25"
                        aria-valuemin="0" aria-valuemax="100" style="width: 25%;"></div>
                </div>
            </div>
        </div>
    </div>




                                                                            <button id="checkoutBtn" type="submit"
                                                                                class="site-btn">PLACE ORDER</button>
                            </div>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </section>

    <% if (address && address.length> 0) { %>
        <div class="container mt-4">
            <div class="row">
                <% address.forEach(address=> { %>
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card shadow" style="width: 18rem;">
                            <div class="card-body">
                                <p>
                                    <%= address.Address_id.FirstName %>
                                        <%= address.Address_id.LastName %>
                                </p>
                                <p>
                                    <%= address.Address_id.House_number %>
                                </p>
                                <p>
                                    <%= address.Address_id.Address_line_1 %>, <%= address.Address_id.Address_line_2 %>
                                </p>
                                <p>
                                    <%= address.Address_id.Postal_code %>
                                </p>
                                <p>
                                    <%= address.Address_id.State %>
                                </p>
                                <p>
                                    <%= address.Address_id.Country %>
                                </p>
                                <button class="btn btn-primary btn-block set-shipping" data-user-id="<%= user._id %>"
                                    data-address-id="<%= address._id %>">Select
                                    as Shipping</button>
                                <button class="btn btn-secondary btn-block set-billing" data-user-id="<%= user._id %>"
                                    data-address-id="<%= address._id %>">Select
                                    as Billing</button>
                            </div>
                        </div>
                    </div>
                    <% }); %>
            </div>
        </div>
        <% } %>


            <!-- Checkout Section End -->

            <!-- Footer Section Begin -->
            <footer class="footer">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="footer__about">
                                <div class="footer__logo">
                                    <a href="#"><img src="img/footer-logo.png" alt=""></a>
                                </div>
                                <p>The customer is at the heart of our unique business model, which includes design.</p>
                                <a href="#"><img src="img/payment.png" alt=""></a>
                            </div>
                        </div>
                        <div class="col-lg-2 offset-lg-1 col-md-3 col-sm-6">
                            <div class="footer__widget">
                                <h6>Shopping</h6>
                                <ul>
                                    <li><a href="#">Clothing Store</a></li>
                                    <li><a href="#">Trending Shoes</a></li>
                                    <li><a href="#">Accessories</a></li>
                                    <li><a href="#">Sale</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-3 col-sm-6">
                            <div class="footer__widget">
                                <h6>Shopping</h6>
                                <ul>
                                    <li><a href="#">Contact Us</a></li>
                                    <li><a href="#">Payment Methods</a></li>
                                    <li><a href="#">Delivary</a></li>
                                    <li><a href="#">Return & Exchanges</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-3 offset-lg-1 col-md-6 col-sm-6">
                            <div class="footer__widget">
                                <h6>NewLetter</h6>
                                <div class="footer__newslatter">
                                    <p>Be the first to know about new arrivals, look books, sales & promos!</p>
                                    <form action="#">
                                        <input type="text" placeholder="Your email">
                                        <button type="submit"><span class="icon_mail_alt"></span></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                   
                    <div class="row">
                        <div class="col-lg-12 text-center">
                            <div class="footer__copyright__text">
                                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                                <p>Copyright ©
                                    <script>
                                        document.write(new Date().getFullYear());
                                    </script>2020
                                    All rights reserved | This template is made with <i class="fa fa-heart-o"
                                        aria-hidden="true"></i> by <a href="https://colorlib.com"
                                        target="_blank">Colorlib</a>
                                </p>
                                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
            <!-- Footer Section End -->

            <!-- Search Begin -->
            <div class="search-model">
                <div class="h-100 d-flex align-items-center justify-content-center">
                    <div class="search-close-switch">+</div>
                    <form class="search-model-form">
                        <input type="text" id="search-input" placeholder="Search here.....">
                    </form>
                </div>
            </div>

            <!-- Search End -->
            <style>
                .checkout__input__radio {
                    display: flex;
                    align-items: center;
                    margin-bottom: 10px;
                }




                .checkout__input__radio .checkmark::after {
                    content: "";
                    position: absolute;
                    display: none;
                }

                .checkout__input__radio input[type="radio"]:checked+.checkmark::after {
                    display: block;
                }

                .checkout__input__radio .checkmark::after {
                    left: 8px;
                    top: 4px;
                    width: 3px;
                    height: 8px;
                    border: solid white;
                    border-width: 0 3px 3px 0;
                    transform: rotate(45deg);
                }
            </style>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


            <!-- Js Plugins -->
            <script src="js/jquery-3.3.1.min.js"></script>
            <script src="js/bootstrap.min.js"></script>
            <script src="js/jquery.nice-select.min.js"></script>
            <script src="js/jquery.nicescroll.min.js"></script>
            <script src="js/jquery.magnific-popup.min.js"></script>
            <script src="js/jquery.countdown.min.js"></script>
            <script src="js/jquery.slicknav.js"></script>
            <script src="js/mixitup.min.js"></script>
            <script src="js/owl.carousel.min.js"></script>
            <script src="js/main.js"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {


            // Validate the checkout form
            function validateCheckoutForm() {

                const requiredFields = [
                    'billingFirstName',
                    'billingLastName',
                    'billingCountry',
                    'billingHouseNumber',
                    'billingAddressLine1',
                    'billingState',
                    'billingPostalCode',
                    'phone',
                    'email'
                ];

                // Validate required fields
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        document.getElementById('paymentMessage').innerText = `Please fill out the ${fieldId.replace('billing', '').replace(/([A-Z])/g, ' $1').toLowerCase()} field.`;
                        document.getElementById('paymentMessage').style.display = 'block';

                        field.focus();
                        return false;
                    }
                }

                // Validate Indian PIN code format
                const pinCodePattern = /^[1-9][0-9]{5}$/;
                const billingPostalCode = document.getElementById('billingPostalCode');
                const shippingPostalCode = document.getElementById('shippingPostalCode');

                if (!pinCodePattern.test(billingPostalCode.value)) {
                    document.getElementById('paymentMessage').innerText = 'Please enter a valid Indian PIN code for Billing Address.';
                    document.getElementById('paymentMessage').style.display = 'block';
                    billingPostalCode.focus();
                    return false;
                }

                if (!pinCodePattern.test(shippingPostalCode.value)) {
                    document.getElementById('paymentMessage').innerText = 'Please enter a valid Indian PIN code for Shipping Address.';
                    document.getElementById('paymentMessage').style.display = 'block';
                    shippingPostalCode.focus();
                    return false;
                }

                // Validate shipping address fields if the checkbox is checked

                const shippingFields = [
                    'shippingFirstName',
                    'shippingLastName',
                    'shippingCountry',
                    'shippingHouseNumber',
                    'shippingAddressLine1',
                    'shippingState',
                    'shippingPostalCode'
                ];

                for (const fieldId of shippingFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        document.getElementById('paymentMessage').innerText = `Please fill out the ${fieldId.replace('shipping', '').replace(/([A-Z])/g, ' $1').toLowerCase()} field.`;
                        document.getElementById('paymentMessage').style.display = 'block';
                        field.focus();
                        return false;
                    }
                }

                // Validate shipping PIN code format
                if (!pinCodePattern.test(shippingPostalCode.value)) {
                    document.getElementById('paymentMessage').innerText = 'Please enter a valid Indian PIN code for Shipping Address.';
                    document.getElementById('paymentMessage').style.display = 'block';
                    shippingPostalCode.focus();
                    return false;
                }



                return true;
            }


            $('#checkoutBtn').click(function (event) {
                const paymentMethod = $('input[name="payment_method"]:checked').val();
                if (!paymentMethod) {
                    event.preventDefault();
                    document.getElementById('paymentMessage').innerText = 'Please select a payment method.';
                    document.getElementById('paymentMessage').style.display = 'block';
                }  else {
                    document.getElementById('paymentMessage').style.display = 'none';
                    if (paymentMethod === 'Wallet Payment') {
                        const selectedInput = $('input[name="payment_method"]:checked');
                        const finalAmount = parseFloat(selectedInput.data('final-amount'));
                        const walletAmount = parseFloat(selectedInput.data('wallet-amount'));

                        if (finalAmount > walletAmount) {
                            event.preventDefault();
                            document.getElementById('paymentMessage').innerText = 'Insufficient wallet Balance.';
                            document.getElementById('paymentMessage').style.display = 'block';
                        }
                    }
                }
            });
            // Function to show modal based on type and message

            // Handle form submission



            document.getElementById('checkoutForm').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent form submission

                if (!validateCheckoutForm()) {
                    return;
                }

                const formData = new FormData(document.getElementById('checkoutForm'));

                fetch('/checkout', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                             
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Form submission successful', data);
                        if (data.message === "Order placed successfully") {
                            window.location.href = `user/orders`;
                        } else if (data.razorDetails) {
                            var options = {
                                "key": "rzp_test_oD4HudkUX2nicH",
                                "amount": data.razorDetails.amount,
                                "currency": "USD",
                                "name": "Male Fashion",
                                "description": "Test Transaction",
                                "image": "img/logo.png",
                                "order_id": data.razorDetails.id,
                                "handler": function (response) {
                                    // Call verifyPayment function on successful payment

                                    verifyPayment(response, data.razorDetails);
                                },
                                "prefill": {
                                    "name": "Gaurav Kumar",
                                    "email": "gaurav.kumar@example.com",
                                    "contact": "9000090000"
                                },
                                "notes": {
                                    "address": "Razorpay Corporate Office"
                                },
                                "theme": {
                                    "color": "#3399cc"
                                }, "modal": {
                                    "ondismiss": function () {
                                        console.log(data.razorDetails);
                                        window.location.href = `payment-failed?receipt=${data.razorDetails.receipt}`;
                                    }
                                }
                            };
                            var rzp1 = new Razorpay(options);
                            rzp1.open();
                        } else {
                            console.log('Order placement failed or invalid response');

                        }
                    })
                    .catch(error => {
                        console.error('Error during form submission', error);
                    });
            });

            // Verify the payment with the server
            function verifyPayment(payment, order) {
                console.log(payment, order);
                $.ajax({
                    url: '/verify-payment',
                    data: {
                        payment,
                        order
                    },
                    method: "post",
                    success: function (response) {
                        if (response.message === "Order placed successfully") {
                            window.location.href = '/user/orders';
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (error) {
                        alert("Payment verification failed");
                    }
                });
            }

        });

    </script>


            <!-- <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const showCouponForm = document.getElementById("show-coupon-form");
                    const couponFormContainer = document.getElementById("coupon-form-container");

                    // Toggle visibility of the coupon form
                    showCouponForm.addEventListener("click", (event) => {
                        event.preventDefault(); // Prevent the default anchor action
                        couponFormContainer.style.display = couponFormContainer.style.display === "none" ? "block" : "none";
                    });
                });

            </script>
            <script>
                $(document).ready(function () {
                    $('#coupon-form').submit(function (event) {
                        event.preventDefault();
                        const couponCode = $('#coupon-code').val();
                        const userId = '<%= user._id %>'; // Make sure to pass userId from server-side to your template
                        const subTotal = '<%= totalCartAmount %>';
                        const storeDiscount = '<%= totalOfferDiscount %>'
                            console.log(subTotal);
                            console.log(storeDiscount);
                        $.ajax({
                            url: '/verify-coupon',
                            method: 'POST',
                            data: { couponCode, userId },
                            success: function (response) {
                                console.log(response.discountAmount); // Check if this logs the expected discount amount
                                console.log(response.newTotalAmount);
                                if (response.valid) {
                                    $('#coupon-message').text('Coupon applied successfully!').css('color', 'green');
                                    // $('#coupon-discount').text(`$ ${response.discountAmount.toFixed(2)}`);
                                    // $('#total-amount').text(`$ ${response.newTotalAmount.toFixed(2)}`);
                                     $('#coupon-discount').text(`$ ${((subTotal - storeDiscount)* response.couponPercenetge).toFixed(2)}`);
                                     $('#total-amount').text(`$ ${(subTotal - storeDiscount -((subTotal - storeDiscount) * response.couponPercenetge)).toFixed(2)}`)
                                } else {
                                    $('#coupon-message').text(response.message).css('color', 'red');
                                }
                            },
                            error: function (xhr) {
                                $('#coupon-message').text('An error occurred. Please try again.').css('color', 'red');
                            }
                        });
                    });
                });
            </script> -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                        const couponCards = document.querySelectorAll('.coupon-card');
                        const couponInput = document.getElementById('coupon-code');

                        couponCards.forEach(card => {
                            card.addEventListener('click', function () {
                                const couponCode = this.getAttribute('data-code');
                                couponInput.value = couponCode;
                            });
                        });
                    });

            </script>
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                        const showCouponForm = document.getElementById("show-coupon-form");
                        const couponFormContainer = document.getElementById("coupon-form-container");

                        // 1. Toggle visibility of the coupon form
                        showCouponForm.addEventListener("click", (event) => {
                            event.preventDefault(); // Prevent the default anchor action
                            couponFormContainer.style.display = couponFormContainer.style.display === "none" ? "block" : "none";
                        });
                    });

                    $(document).ready(function () {
                        let appliedCoupons = []; // 2. Initialize an array to store applied coupons

                        $('#coupon-form').submit(function (event) {
                            event.preventDefault(); // 3. Prevent default form submission

                            const couponCode = $('#coupon-code').val();
                            const userId = '<%= user._id %>'; // 4. Pass userId from server-side to template
                            const subTotal = parseFloat('<%= totalCartAmount %>');
                            const storeDiscount = parseFloat('<%= totalOfferDiscount %>');

                            // 5. Send an AJAX request to verify the coupon
                            $.ajax({
                                url: '/verify-coupon',
                                method: 'POST',
                                data: { couponCode, userId, storeDiscount, subTotal },
                                success: function (response) {
                                    if (response.valid) {
                                        console.log("response.couponPercentage is :", response.couponPercenetge);
                                        appliedCoupons.push(response); // 6. Add the valid coupon to the appliedCoupons array
                                        $('#coupon-discount').text(`$ ${((subTotal - storeDiscount) * (response.couponPercenetge)/100).toFixed(2)}`);
                                        $('#total-amount').text(`$ ${(subTotal - storeDiscount - ((subTotal - storeDiscount) * (response.couponPercenetge)/100)).toFixed(2)}`)
                                         $('input[name="total"]').val((subTotal - storeDiscount - ((subTotal - storeDiscount) * (response.couponPercenetge)/100)).toFixed(2));

                                      // 7. Create a coupon element with a close button
                                        const couponElement = $('<div>').addClass('coupon-item');
                                        const couponText = $('<span>').text(`${couponCode}`);
                                        const removeButton = $('<button>').addClass('remove-coupon').text('x').data('code', couponCode);
                                        couponElement.append(couponText).append(removeButton);
                                        $('#applied-coupons').append(couponElement);
                                       
                                        // Update the hidden fields for coupon code
                                        $('input[name="coupon_code"]').val(response.bestCouponCode);
                                        $('input[name="couponDiscount"]').val(((subTotal - storeDiscount) * response.couponPercenetge).toFixed(2));
                                         $('input[name="couponDiscountPercentage"]').val(response.couponPercenetge);
                                        $('#applied-coupons').find('li:hidden').each(function () {
                                            if ($(this).find('input[name="coupon_code"]').val() === response.bestCouponCode) {
                                                $(this).find('span').text(response.bestCouponCode);
                                            }
                                        });
                                       
                                        $('#applied-coupons').append(couponElement); // 12. Append the coupon element to the applied-coupons container

                                        $('#coupon-message').text('Coupon applied successfully!').css('color', 'green'); // 13. Display success message
                                        
                                    } else {
                                        $('#coupon-message').text(response.message).css('color', 'red'); // 15. Display error message
                                    }
                                },
                                error: function (xhr) {
                                    $('#coupon-message').text('An error occurred. Please try again.').css('color', 'red'); // 16. Display error message if AJAX request fails
                                }
                            });
                        });
 
         
                    
                    });

            </script>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                $(document).ready(function () {
                    $('.set-shipping').click(function () {
                        var addressId = $(this).data('address-id');
                        $.ajax({
                            url: '/user/setshipping/' + addressId,
                            type: 'GET',
                            success: function (response) {
                                if (response && response.Address_id) {
                                    $('#shippingFirstName').val(response.Address_id.FirstName);
                                    $('#shippingLastName').val(response.Address_id.LastName);
                                    $('#shippingCountry').val(response.Address_id.Country);
                                    $('#shippingHouseNumber').val(response.Address_id.House_number);
                                    $('#shippingAddressLine1').val(response.Address_id.Address_line_1 + ', ' + response.Address_id.Address_line_2);
                                    $('#shippingState').val(response.Address_id.State);
                                    $('#shippingPostalCode').val(response.Address_id.Postal_code);
                                    alert('Shipping address updated successfully');
                                } else {
                                    alert('Failed to update shipping address');
                                }
                            },
                            error: function (error) {
                                alert('Failed to update shipping address');
                            }
                        });
                    });

                    $('.set-billing').click(function () {
                        var addressId = $(this).data('address-id');
                        $.ajax({
                            url: '/user/setbilling/' + addressId,
                            type: 'GET',
                            success: function (response) {
                                if (response && response.Address_id) {
                                    $('#billingFirstName').val(response.Address_id.FirstName);
                                    $('#billingLastName').val(response.Address_id.LastName);
                                    $('#billingCountry').val(response.Address_id.Country);
                                    $('#billingHouseNumber').val(response.Address_id.House_number);
                                    $('#billingAddressLine1').val(response.Address_id.Address_line_1 + ', ' + response.Address_id.Address_line_2);
                                    $('#billingState').val(response.Address_id.State);
                                    $('#billingPostalCode').val(response.Address_id.Postal_code);
                                    alert('Billing address updated successfully');
                                } else {
                                    alert('Failed to update billing address');
                                }
                            },
                            error: function (error) {
                                alert('Failed to update billing address');
                            }
                        });
                    });
                });

            </script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get elements
        const shipToSameAddressCheckbox = document.getElementById('add');
        const billingFields = {
            firstName: document.getElementById('billingFirstName'),
            lastName: document.getElementById('billingLastName'),
            country: document.getElementById('billingCountry'),
            houseNumber: document.getElementById('billingHouseNumber'),
            addressLine1: document.getElementById('billingAddressLine1'),
            state: document.getElementById('billingState'),
            postalCode: document.getElementById('billingPostalCode')
        };
        const shippingFields = {
            firstName: document.getElementById('shippingFirstName'),
            lastName: document.getElementById('shippingLastName'),
            country: document.getElementById('shippingCountry'),
            houseNumber: document.getElementById('shippingHouseNumber'),
            addressLine1: document.getElementById('shippingAddressLine1'),
            state: document.getElementById('shippingState'),
            postalCode: document.getElementById('shippingPostalCode')
        };

        // Toggle shipping address fields
        function toggleShippingAddressFields() {
            const isChecked = shipToSameAddressCheckbox.checked;
            const shippingDetailsContainer = document.getElementById('shippingDetails');
            shippingDetailsContainer.style.display = isChecked ? 'none' : 'block';

            if (isChecked) {
                // Copy values from billing address to shipping address
                shippingFields.firstName.value = billingFields.firstName.value;
                shippingFields.lastName.value = billingFields.lastName.value;
                shippingFields.country.value = billingFields.country.value;
                shippingFields.houseNumber.value = billingFields.houseNumber.value;
                shippingFields.addressLine1.value = billingFields.addressLine1.value;
                shippingFields.state.value = billingFields.state.value;
                shippingFields.postalCode.value = billingFields.postalCode.value;
            } else {
                // Clear shipping address fields if not shipping to the same address
                for (const key in shippingFields) {
                    shippingFields[key].value = '';
                }
            }
        }

        // Add event listener
        shipToSameAddressCheckbox.addEventListener('change', toggleShippingAddressFields);
    });
</script>

<!-- <script>
     // Handle the close coupon form button click
        $('#applied-coupons').on('click', '.remove-coupon', function () {
            console.log("button clicked");
             const couponCode = $(this).data('code');
            $.ajax({
                url: '/delete-coupon',
                method: 'GET',
                data: { couponCode: couponCode },
                success: function () {
                    $('#coupon-form-container').hide();
                    $('#coupon-message').text('Coupon removed successfully!').css('color', 'green');
                     $('#coupon-code').val('');  // Clear the coupon input field
                    $('#coupon-discount').text('0.00');
                    $('#total-amount').text(`$ <%= (totalCartAmount-totalOfferDiscount).toFixed(2) %>`);  // Reset to the original total amount
                },
                error: function (xhr) {
                    $('#coupon-message').text('An error occurred. Please try again.').css('color', 'red');
                }
            });
        });

</script> -->
<script>
     $('#applied-coupons').on('click', '.remove-coupon', function () {
            console.log("button clicked");
            const couponCode = $(this).data('code');
            const userId = '<%= user._id %>'; // Ensure userId is available
            const subTotal = '<%= totalCartAmount %>';
            const storeDiscount = '<%= totalOfferDiscount %>';
            const couponElement = $(this).closest('.coupon-item');

            $.ajax({
                url: '/delete-coupon',
                method: 'GET',
                data: { couponCode: couponCode, userId: userId , subTotal : subTotal , storeDiscount : storeDiscount },
                success: function (response) {
                    // Remove the coupon element
                      couponElement.remove();
                    const discountAmount = ((subTotal - storeDiscount) * response.couponPercentage ).toFixed(2);
                    const newTotalAmount = (subTotal - storeDiscount - discountAmount).toFixed(2);
                    // Update the discount and total amount based on the response

                    console.log(discountAmount);
                     console.log(response.couponPercentage);

                    $('#coupon-discount').text(`$ ${discountAmount}`);
                    $('input[name="couponDiscount"]').val(discountAmount);
                    $('input[name="couponDiscountPercentage"]').val(response.couponPercentage);
                    $('input[name="total"]').val(newTotalAmount);
                    $('#total-amount').text(`$ ${newTotalAmount}`);
                    

                    if (response.bestCouponCode) {
                        $('input[name="coupon_code"]').val(response.bestCouponCode);
                        $('#applied-coupons').find('li:hidden').each(function () {
                            if ($(this).find('input[name="coupon_code"]').val() === response.bestCouponCode) {
                                $(this).find('span').text(response.bestCouponCode);
                            }
                        });
                    }




                    $('#coupon-message').text('Coupon removed successfully!').css('color', 'green');
                },
                error: function (xhr) {
                    $('#coupon-message').text('An error occurred. Please try again.').css('color', 'red');
                }
            });
        });
</script>



</body>

</html>